!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).mtrXYZ=t.mtrXYZ||{})}(this,(function(t){"use strict";function e(t,e=-1){let a=!("auto"!=e||!t[0].hasOwnProperty("decimals"));for(let l=0,s=t.length;l<s;l++){let s=t[l];(e>-1||a)&&(e=a?s.decimals:e,t[l].values=s.values.map((t=>+t.toFixed(e))))}return t}function a(t,e,a=1){const l=2*Math.PI;let[s,r,n,y,x,o,i]=e;if(0===s||0===r)return[];let u=n?n*l/360:0,c=u?Math.sin(u):0,h=u?Math.cos(u):1,p=h*(t.x-o)/2+c*(t.y-i)/2,f=-c*(t.x-o)/2+h*(t.y-i)/2;if(0===p&&0===f)return[];s=Math.abs(s),r=Math.abs(r);let m=p*p/(s*s)+f*f/(r*r);if(m>1){let t=Math.sqrt(m);s*=t,r*=t}let g=s*s,v=s===r?g:r*r,d=p*p,M=f*f,P=g*v-g*M-v*d;P<=0?P=0:(P/=g*M+v*d,P=Math.sqrt(P)*(y===x?-1:1));let A=P?P*s/r*f:0,b=P?P*-r/s*p:0,I=h*A-c*b+(t.x+o)/2,Z=c*A+h*b+(t.y+i)/2,$=(p-A)/s,X=(f-b)/r,Y=(-p-A)/s,T=(-f-b)/r;const w=(t,e,a,l)=>{let s=+(t*a+e*l).toFixed(9);return 1===s||-1===s?1===s?0:Math.PI:(s=s>1?1:s<-1?-1:s,(t*l-e*a<0?-1:1)*Math.acos(s))};let C=w(1,0,$,X),k=w($,X,Y,T);0===x&&k>0?k-=2*Math.PI:1===x&&k<0&&(k+=2*Math.PI);let D=(+(Math.abs(k)/(l/4)).toFixed(0)||1)*a;k/=D;let S=[];const j=1.5707963267948966,q=.551785;let L=k===j?q:k===-j?-q:4/3*Math.tan(k/4),E=k?Math.cos(k):1,F=k?Math.sin(k):0;const H=(t,e,a,l,s)=>{let r=t!=e?Math.cos(t):l,n=t!=e?Math.sin(t):s,y=Math.cos(t+e),x=Math.sin(t+e);return[{x:r-n*a,y:n+r*a},{x:y+x*a,y:x-y*a},{x:y,y:x}]};for(let t=0;t<D;t++){let t={type:"C",values:[]};H(C,k,L,E,F).forEach((e=>{let a=e.x*s,l=e.y*r;t.values.push(h*a-c*l+I,c*a+h*l+Z)})),S.push(t),C+=k}return S}function l(t,e=!1,a=-1){a>=0&&(t[0].values=t[0].values.map((t=>+t.toFixed(a))));let l=t[0].values,s=l[0],r=l[1],n=s,y=r;for(let l=1,x=t.length;l<x;l++){let x=t[l],{type:o,values:i}=x,u=e?o.toLowerCase():o.toUpperCase();if(o!==u)switch(o=u,x.type=o,o){case"a":case"A":i[5]=e?i[5]-s:i[5]+s,i[6]=e?i[6]-r:i[6]+r;break;case"v":case"V":i[0]=e?i[0]-r:i[0]+r;break;case"h":case"H":i[0]=e?i[0]-s:i[0]+s;break;case"m":case"M":e?(i[0]-=s,i[1]-=r):(i[0]+=s,i[1]+=r),n=e?i[0]+s:i[0],y=e?i[1]+r:i[1];break;default:if(i.length)for(let t=0;t<i.length;t++)i[t]=e?i[t]-(t%2?r:s):i[t]+(t%2?r:s)}let c=i.length;switch(o){case"z":case"Z":s=n,r=y;break;case"h":case"H":s=e?s+i[0]:i[0];break;case"v":case"V":r=e?r+i[0]:i[0];break;case"m":case"M":n=i[c-2]+(e?s:0),y=i[c-1]+(e?r:0);default:s=i[c-2]+(e?s:0),r=i[c-1]+(e?r:0)}a>=0&&(x.values=x.values.map((t=>+t.toFixed(a))))}return t}const{abs:s,acos:r,atan:n,atan2:y,cos:x,sin:o,log:i,max:u,min:c,sqrt:h,tan:p,PI:f,pow:m}=Math;mtrXYZ.Mtx.prototype.transformPathData=function(t,e=8){let a=mtrXYZ.transformPathData(t,this.matrix,this.perspectiveOrigin,this.perspective,e);return this.ptsT=a,a},t.convertPathData=function(t,{normalize:s=null,optimize:r=1,toAbsolute:n=!0,toRelative:y=!1,quadraticToCubic:x=!1,lineToCubic:o=!1,toLonghands:i=!0,toShorthands:u=!1,arcToCubic:c=!1,arcParam:h=!1,arcAccuracy:p=1,optimizeOrder:f=!1,reorderSub:m=!1,simplify:g=!1,cubicToQuadratic:v=!1,cubicToQuadraticPrecision:d=.1,decimals:M=-1,cubicToArcs:P=!1}={}){return!0===s&&(n=!0,i=!0,c=!0,u=!1),t=JSON.parse(JSON.stringify(t)),n&&(t=l(t)),i&&(t=function(t,e=-1,a=!0){let s;if(a){let e=t.map((t=>t.type)).join(""),a=/[hstv]/gi.test(e);if(s=/[astvqmhlc]/g.test(e),!a)return t}t=a&&s?l(t,!1,e):t;let r=[],n={type:"M",values:t[0].values};r.push(n);for(let a=1,l=t.length;a<l;a++){let l,s,y,x,o,i,u,c,h=t[a],{type:p,values:f}=h,m=f.length,g=n.values,v=g.length,[d,M]=[f[m-2],f[m-1]],[P,A]=[g[v-2],g[v-1]];switch(p){case"H":n={type:"L",values:[f[0],A]};break;case"V":n={type:"L",values:[P,f[0]]};break;case"T":[l,s]=[g[0],g[1]],[P,A]=[g[v-2],g[v-1]],y=P+(P-l),x=A+(A-s),n={type:"Q",values:[y,x,d,M]};break;case"S":[l,s]=[g[0],g[1]],[u,c]=v>2?[g[2],g[3]]:[g[0],g[1]],[P,A]=[g[v-2],g[v-1]],y=2*P-u,x=2*A-c,o=f[0],i=f[1],n={type:"C",values:[y,x,o,i,d,M]};break;default:n={type:p,values:f}}e>-1&&(n.values=n.values.map((t=>+t.toFixed(e)))),r.push(n)}return r}(t,-1,!1)),c&&(t=function(t,{arcAccuracy:e=1}={}){let l=[t[0]];for(let s=1,r=t.length;s<r;s++){let r=t[s],n=t[s-1].values,y=n.length,x={x:n[y-2],y:n[y-1]};if("A"===r.type){a(x,r.values,e).forEach((t=>{l.push(t)}))}else l.push(r)}return l}(t)),u&&(t=function(t,e=-1,a=!0){let s;if(a){let e=t.map((t=>t.type)).join("");s=/[astvqmhlc]/g.test(e)}t=a&&s?l(t,!1,e):t;let r={type:"M",values:t[0].values};t[0].decimals&&(r.decimals=t[0].decimals);let n,y=[r],x={x:t[0].values[0],y:t[0].values[1]},o=.01;for(let a=1,l=t.length;a<l;a++){let l=t[a],{type:s,values:i}=l,u=i.slice(-2),c=t[a-1],h=c.type;n={x:u[0],y:u[1]};let p,f,m,g,v={x:i[0],y:i[1]},d=Math.abs(n.x-x.x),M=Math.abs(n.y-x.y),P=(d+M)/2*o;switch(s){case"L":r=0===M||M<P&&d>P?{type:"H",values:[i[0]]}:0===d||M>P&&d<P?{type:"V",values:[i[1]]}:l;break;case"Q":if("Q"!==h){x={x:u[0],y:u[1]},y.push(l);continue}let t={x:c.values[0],y:c.values[1]};g={x:2*x.x-t.x,y:2*x.y-t.y},p=Math.abs(v.x-g.x),f=Math.abs(v.y-g.y),m=(p+f)/2,r=m<P?{type:"T",values:[n.x,n.y]}:l;break;case"C":let e={x:i[2],y:i[3]};if("C"!==h){y.push(l),x={x:u[0],y:u[1]};continue}let a={x:c.values[2],y:c.values[3]};g={x:2*x.x-a.x,y:2*x.y-a.y},p=Math.abs(v.x-g.x),f=Math.abs(v.y-g.y),m=(p+f)/2,r=m<P?{type:"S",values:[e.x,e.y,n.x,n.y]}:l;break;default:r={type:s,values:i}}(l.decimals||0===l.decimals)&&(r.decimals=l.decimals),e>-1&&(r.values=r.values.map((t=>+t.toFixed(e)))),x={x:u[0],y:u[1]},y.push(r)}return y}(t)),y&&(t=l(t,!0)),t=function(t){for(let e=0,a=t.length;a&&e<a;e++){let a=t[e];if("A"===a.type){let l=t[e-1].values.slice(-2),s={x:l[0],y:l[1]},[r,n,y,x,o,i,u]=a.values,c=mtrXYZ.svgArcToCenterParam(s.x,s.y,r,n,y,x,o,i,u);a.rx=c.rx,a.ry=c.ry,a.cx=c.cx,a.cy=c.cy,a.xAxisRotation=y,a.largeArc=x,a.startAngle=c.startAngle,a.endAngle=c.endAngle,a.deltaAngle=c.deltaAngle}}return t}(t),-1!==M&&(t=e(t,M)),t},t.getConvexHullMatrix=function(t){t.map((t=>({x:+t.x.toFixed(2),y:+t.y.toFixed(2)})));let[e,a,l,s]=t,r={m00:a.x*l.x*s.y-e.x*l.x*s.y-a.x*l.y*s.x+e.x*l.y*s.x-e.x*a.y*s.x+e.y*a.x*s.x+e.x*a.y*l.x-e.y*a.x*l.x,m01:e.x*l.x*s.y-e.x*a.x*s.y-a.x*l.y*s.x+a.y*l.x*s.x-e.y*l.x*s.x+e.y*a.x*s.x+e.x*a.x*l.y-e.x*a.y*l.x,m02:a.x*l.x*s.y-e.x*a.x*s.y-e.x*l.y*s.x-a.y*l.x*s.x+e.y*l.x*s.x+e.x*a.y*s.x+e.x*a.x*l.y-e.y*a.x*l.x,m10:a.y*l.x*s.y-e.y*l.x*s.y-e.x*a.y*s.y+e.y*a.x*s.y-a.y*l.y*s.x+e.y*l.y*s.x+e.x*a.y*l.y-e.y*a.x*l.y,m11:-a.x*l.y*s.y+e.x*l.y*s.y+a.y*l.x*s.y-e.x*a.y*s.y-e.y*l.y*s.x+e.y*a.y*s.x+e.y*a.x*l.y-e.y*a.y*l.x,m12:a.x*l.y*s.y-e.x*l.y*s.y+e.y*l.x*s.y-e.y*a.x*s.y-a.y*l.y*s.x+e.y*a.y*s.x+e.x*a.y*l.y-e.y*a.y*l.x,m20:a.x*s.y-e.x*s.y-a.y*s.x+e.y*s.x-a.x*l.y+e.x*l.y+a.y*l.x-e.y*l.x,m21:l.x*s.y-a.x*s.y-l.y*s.x+a.y*s.x+e.x*l.y-e.y*l.x-e.x*a.y+e.y*a.x,m22:l.x*s.y-e.x*s.y-l.y*s.x+e.y*s.x+a.x*l.y-a.y*l.x+e.x*a.y-e.y*a.x};return Object.entries(r).forEach((function(t){Number(t[1])})),r},t.getEllipeHull=function(t,e,a,l,s){const r=(t,e,a,l,s=!1)=>{if(s&&(l=l*Math.PI/180),0===l)return t;let r=Math.cos(l),n=Math.sin(l);return{x:r*(t.x-e)+n*(t.y-a)+e,y:r*(t.y-a)-n*(t.x-e)+a}};let n=s>0?Math.PI/-2:Math.PI/2;return[r({x:t-a,y:e-l},t,e,-(s=s?s+n:0)),r({x:t+a,y:e-l},t,e,-s),r({x:t+a,y:e+l},t,e,-s),r({x:t-a,y:e+l},t,e,-s)]},t.getEllipseProperties=function(t){let{m00:e,m01:a,m02:l,m10:s,m11:r,m12:n,m20:y,m21:x,m22:o}=t;const i=+e*(r*o-x*n)-a*(s*o-n*y)+l*(s*x-r*y);if(0==i)return null;const u=1/i,c=(r*o-x*n)*u,h=-(a*o-l*x)*u,p=(a*n-l*r)*u,f=-(s*o-n*y)*u,m=(e*o-l*y)*u,g=-(e*n-s*l)*u,v=(s*x-y*r)*u,d=-(e*x-y*a)*u,M=(e*r-s*a)*u;let P=c*c+f*f-v*v,A=c*h+f*m-v*d,b=h*h+m*m-d*d,I=c*p+f*g-v*M,Z=h*p+m*g-d*M,$=p*p+g*g-M*M,X=0;return 0==A&&P<=b?X=0:0==A&&P>=b?X=Math.PI/2:(0!=A&&P>b||0!=A&&P<=b)&&(X=Math.PI/2+.5*(Math.PI/2-Math.atan2(P-b,2*A))),X=180*X/Math.PI,{cx:(b*I-A*Z)/(A*A-P*b),cy:(P*Z-A*I)/(A*A-P*b),rx:Math.sqrt(2*(P*Z*Z+b*I*I+$*A*A-2*A*I*Z-P*b*$)/((A*A-P*b)*(Math.sqrt((P-b)*(P-b)+4*A*A)-(P+b)))),ry:Math.sqrt(2*(P*Z*Z+b*I*I+$*A*A-2*A*I*Z-P*b*$)/((A*A-P*b)*(-Math.sqrt((P-b)*(P-b)+4*A*A)-(P+b)))),angle:X}},t.getPointOnEllipse=function(t,e,a,l,s,r=0,y=!0,i=!1){if(s=i?s*f/180:s,r=i?r*f/180:r,r=a!==l&&r!==2*f?r:0,y&&a!==l){let t=n(p(s=r?s-r:s)*(a/l));s=x(s)<0?t+f:t}let u=t+a*x(s),c=e+l*o(s),h={x:u,y:c};return r&&(h.x=t+(u-t)*x(r)-(c-e)*o(r),h.y=e+(u-t)*o(r)+(c-e)*x(r)),h},t.getPolygonArea=function(t,e=.001){let a=0;for(let e=0,l=t.length;l&&e<l;e++){a+=t[e].x*t[e===t.length-1?0:e+1].y*.5-t[e===t.length-1?0:e+1].x*t[e].y*.5}return a},t.parse=function(t,e=!0){e="log";const a={77:2,109:2,65:7,97:7,67:6,99:6,72:1,104:1,76:2,108:2,81:4,113:4,83:4,115:4,84:2,116:2,86:1,118:1,90:0,122:0},l=new Set([77,109,65,97,67,99,72,104,76,108,81,113,83,115,84,116,86,118,90,122]),s=new Set([5760,6158,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8239,8287,12288,65279]);let r,n=0,y=t.length,x="",o=[],i=-1,u="",c=!1,h=!1,p=0,f=0,m=0,g=!1,v=!1,d=!1,M=!1,P=!1,A=new Set(["m","c","q","l","a","t","s","v","h"]),b=new Set(["t","s","v","h","T","S","V","H"]),I=new Set(["t","q","T","Q"]),Z=[];function $(){g&&("M"===x?x="L":"m"===x&&(x="l"),o.push({type:x,values:[]}),i++,f=0,g=!1)}function X(t=!1){(t?p>0:""!==u)&&(e&&-1===i&&(r="Pathdata must start with M command",Z.push(r),x="M",o.push({type:x,values:[]}),m=2,f=0,i++),"A"===x||"a"===x?(u=function(){let t=u.length,e=!1;3===f&&2===t||4===f&&t>1?(u=[+u[0],+u[1]],e=!0,f++):3===f&&t>3&&(u=[+u[0],+u[1],+u.substring(2)],e=!0,f+=2);return e?u:[+u]}(),o[i].values.push(...u)):(e&&u[1]&&"."!==u[1]&&"0"===u[0]&&(r="Leading zeros not valid: "+u,Z.push(r)),o[i].values.push(+u)),f++,u="",p=0,g=f>=m)}function Y(){if(e){let t=i>0?o[i]:0,e=t?t.values.length:0;if(e&&e<m||e&&e>m||("z"===x||"Z"===x)&&e>0){r=`Pathdata commands in "${x}" (segment index: ${i}) don't match allowed number of values: ${m-e}/${m}`,Z.push(r)}}}for(;n<y;){let e=t[n],r=t.charCodeAt(n);if(w=r,l.has(w)){""!==u&&(o[i].values.push(+u),f++,u=""),Y(),x=e,m=a[r];let t="M"===x||"m"===x;i>0&&("z"===o[i].type||"Z"===o[i].type)&&!t&&(o.push({type:"m",values:[0,0]}),i++),o.push({type:x,values:[]}),i++,v||(v=A.has(x)),M||(M=b.has(x)),P||(P=I.has(x)),d||(d="a"===x||"A"===x),h=!1,p=0,f=0,g=!1,n++}else if(10===(T=r)||13===T||8232===T||8233===T||32===T||44===T||44===T||9===T||11===T||12===T||160===T||T>=5760&&s.has(T)>=0)X(),h=!0,c=!1,n++;else{if(n===y-1){u+=e,X(),h=!1,c=!1,Y();break}if(!c&&!h&&45===r||!c&&46===r){let t=46===r;X(t),$(),t&&p++}else $();u+=e,c=69===r||101===r,h=!1,n++}}var T,w;return Y(),e&&Z.length&&(r="Invalid path data:\n"+Z.join("\n"),console.log(r)),o[0].type="M",{pathData:o,hasRelatives:v,hasShorthands:M,hasQuadratics:P,hasArcs:d}},t.pathDataToD=function(t,e=1){let a=e>1,l=!a;"l"===t[1].type&&l&&(t[0].type="m");let s="";s=a?`${t[0].type} ${t[0].values.join(" ")}\n`:`${t[0].type}${t[0].values.join(" ")}`;for(let e=1,r=t.length;e<r;e++){let r=t[e-1],n=t[e],{type:y,values:x}=n;if(!l||"A"!==y&&"a"!==y||(x=[x[0],x[1],x[2],`${x[3]}${x[4]}${x[5]}`,x[6]]),y=r.type===n.type&&"m"!==n.type.toLowerCase()&&l||("m"===r.type&&"l"===n.type||"M"===r.type&&"l"===n.type||"M"===r.type&&"L"===n.type)&&l?" ":n.type,l){let t="",e=!1;for(let a=0,l=x.length;a<l;a++){let l=x[a],s=l.toString(),r=s.includes(".")&&Math.abs(l)<1;r&&e&&(s=s.replace(/^0\./,".")),!(a>0)||e&&r||(t+=" "),t+=s,e=r}s+=`${y}${t}`}else s+=a?`${y} ${x.join(" ")}\n`:`${y}${x.join(" ")}`}return l&&(s=s.replace(/ 0\./g," .").replace(/ -/g,"-").replace(/-0\./g,"-.").replace(/Z/g,"z")),s},t.renderPoint=function(t,e,a="red",l="1%",s="1",r="",n=!0,y="",x=""){Array.isArray(e)&&(e={x:e[0],y:e[1]});let o=`<circle class="${x}" opacity="${s}" id="${y}" cx="${e.x}" cy="${e.y}" r="${l}" fill="${a}">\n<title>${r}</title></circle>`;if(!n)return o;t.insertAdjacentHTML("beforeend",o)},t.roundPathData=e,t.svgArcToCenterParam=function(t,e,a,l,r,n,i,u,c){const p=(t,e,a,l)=>y(l-e,a-t);let m={cx:0,cy:0,rx:a=s(a),ry:l=s(l),startAngle:0,endAngle:0,deltaAngle:0,clockwise:i};if(0==a||0==l)throw Error("rx and ry can not be 0");let g,v,d=a===l?0:r*f/180,M=d?o(d):0,P=d?x(d):1,A=(t-u)/2,b=(e-c)/2,I=(t+u)/2,Z=(e+c)/2,$=d?P*A+M*b:A,X=d?P*b-M*A:b,Y=$*$/(a*a)+X*X/(l*l);Y>1&&(a*=h(Y),l*=h(Y),m.rx=a,m.ry=l);let T=a*l,w=a*X,C=l*$,k=w*w+C*C;if(!k)throw Error("start point can not be same as end point");let D=h(s((T*T-k)/k));n==i&&(D=-D);let S=D*w/l,j=-D*C/a;g=d?P*S-M*j+I:I+S,v=d?M*S+P*j+Z:Z+j,m.cy=v,m.cx=g;let q=p(g,v,t,e),L=p(g,v,u,c);!i&&L>q&&(L-=2*Math.PI),i&&q>L&&(L=L<=0?L+2*Math.PI:L);let E=L-q;return m.startAngle=q,m.endAngle=L,m.deltaAngle=E,m},t.transformPathData=function(t,e,a={x:0,y:0},l=1/0,s=-1){t=Array.isArray(t)?t:mtrXYZ.parse(t).pathData,t=mtrXYZ.convertPathData(t,{toAbsolute:!0,toLonghands:!0});let r=[],n=16===Object.values(e).length,y=!1;n&&(y=mtrXYZ.canFlattenTo2D(e,l)),y&&(n=!1,e=mtrXYZ.flattenTo2D(e,l));const x=(t,e,s)=>{let r=e.values,[n,y,x,o,i,u,c]=r,h=x,p=h*Math.PI/180,f={x:u,y:c},m={};m=e.rx?{rx:e.rx,ry:e.ry,cx:e.cx,cy:e.cy,deltaAngle:e.deltaAngle,startAngle:e.startAngle,endAngle:e.endAngle}:mtrXYZ.svgArcToCenterParam(t.x,t.y,n,y,x,o,i,f.x,f.y);let{rx:g,ry:v,cx:d,cy:M,startAngle:P,deltaAngle:A}=m;t=mtrXYZ.transformPoint(t,s,a,l),f=mtrXYZ.transformPoint(f,s,a,l);let b=mtrXYZ.getEllipeHull(d,M,g,v,-p),I=mtrXYZ.transformPoints(b,s,a,l),Z=mtrXYZ.getConvexHullMatrix(I),$=mtrXYZ.getEllipseProperties(Z),X=mtrXYZ.getPointOnEllipse(d,M,g,v,P+.5*A,p);X=mtrXYZ.transformPoint(X,s,a,l);let Y={x:$.cx,y:$.cy};i=mtrXYZ.getPolygonArea([Y,t,X,f])<0?0:1;let T=((t,e,a,l,s)=>{const r=(t,e)=>Math.atan2(e.y-t.y,e.x-t.x);let n=s?l:e,y=r(t,s?e:l),x=r(t,n),o=r(t,a);y=(y+2*Math.PI)%(2*Math.PI),x=(x+2*Math.PI)%(2*Math.PI),o=(o+2*Math.PI)%(2*Math.PI),y<o&&o<x||y>o&&o>x||(x<y?x+=2*Math.PI:y+=2*Math.PI);let i=x-y;return{deltaAngle:i,largeArc:Math.abs(i)>Math.PI?1:0}})(Y,t,X,f,i);return o=T.largeArc,g=$.rx,v=$.ry,h=g!==v?$.angle:0,{type:"A",values:[g,v,h,o,i,f.x,f.y]}};if("100100"===[e.a,e.b,e.c,e.d,e.e,e.f].map((t=>+t.toFixed(1))).join(""))return t;for(let s=0,y=t.length;y&&s<y;s++){let y=t[s],{type:o,values:i}=y,u=o.toLowerCase(),c=(s>0?t[s-1]:t[s]).values,h=c.length,p={x:c[h-2],y:c[h-1]},f={type:o,values:[]};if("a"===u)f=x(p,y,e);else if(i.length)for(let t=0;t<i.length;t+=2){let s=n?mtrXYZ.transformPoint3D({x:y.values[t],y:y.values[t+1]},e,a,l):mtrXYZ.transformPoint2D({x:y.values[t],y:y.values[t+1]},e);f.values[t]=s.x,f.values[t+1]=s.y}r.push(f)}return r}}));
